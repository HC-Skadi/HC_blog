# 图嵌入表示学习



## 如何把节点映射成D维向量--让电脑认识

- 人工特征工程：节点重要度、集群系数、Graphlet

- 图表示学习：
  - 通过随机游走构造的自监督学习。DeepWork、Node2Vec
  - 矩阵分解

- 深度学习：图神经网络



##  图嵌入-定义

- 图表示学习

  - 自动学学习特征，将各模态输入转为向量

  - 端到端，无需人工特征工程，无监督学习
  - 将节点映射为d维向量，向量具有低维（向量维度远小于节点数）、连续（每个元素都是实数）、稠密（每个元素都不为0），与下游任务无关

- **嵌入**d维度空间

  - 向量相似度反映节点相似度

  - 嵌入向量包含网络连接信息



## 图嵌入-基本框架--编码器解码器

- 编码器：输入一个节点，输出这个节点的D维向量  $ENC(u)$     $ENC(v)$
  - ![image-20230221010004621](https://hc-images-1307048923.cos.ap-guangzhou.myqcloud.com/images/202302210100660.png)

- 解码器：输入这个节点的d维向量，输出节点相似度
  - $Similarity(u，v)  \approx z_{u}^{T}z_{v}$ (余弦相似度)
  - 节点的相似度需要人为定义，比如节点相连，节点有共同好友，相同功能（例如马六甲海峡和苏伊士运河）
- 优化目标：迭代优化每个节点的d维向量，使得图中相似节点向量数量积大，不相似节点向量数量积小

### 编码器

- 最简单的编码器：查表 $ENC(v)  = z_v = Z * v$  提取Z矩阵的某一列（一个节点的嵌入向量）
  - 直接优化Z矩阵
  - 优化Z矩阵的方法：DeepWalk、Node2Vec

- 复制的编码器，需要使用deep encoders（GNNS）

### 解码器

- 基于节点相似度
- 目标：对$z_{u}^{T}z_{v}$进行优化迭代每个节点的D维向量，使得使得图中相似节点向量数量积大，不相似节点向量数量积小
- 直接优化嵌入向量，使用随机游走方式，如果两个节点出现在同一个随机游走序列中，就反映了这两个节点是相似的，并与下游任务无关
- 

## 随机游走

- 从一个节点出发，随机地进行游走(可以设置某种策略)

### 符号定义

- $z^u$ ：节点的嵌入向量

- $P(v∣z^u)$：从*u*节点出发的随机游走序列经过*v*节点的概率

- 计算：softmax函数：$\sigma(\mathbf{z})[i]=\frac{e^{z[i]}}{\sum_{j=1}^K e^{\mathbf{z}[j]}}$
  - 可以将实数映射到（0，1）

- $z_{u}^{T}z_{v}\approx$  u和v相似的概率（相似：共同出现在同一个随机游走序列），越大代表越相似

- $N_R(u)$:从u节点出发的随机游走序列的所有邻域节点 



### 好处

- 表示能力强，甚至蕴含多跳的信息

- 计算便捷，只需暴力计算即可

- 无监督/自监督学习，不需要用到下游任何特征

  

### 优化

- 采用极大似然估计，优化目标函数：  $\max_{f} \sum_{u \in V} \log \mathrm{P}\left(N_{\mathrm{R}}(u) \mid \mathbf{z}_u\right)$

- 整个优化的目标函数
  - 优化目标函数的最小值
  - ![image-20230220235622801](https://hc-images-1307048923.cos.ap-guangzhou.myqcloud.com/images/202302202356849.png)
  - 函数复杂度$O（|V|^2)$，复杂度很高，需要工程行进一步优化

- 负采样

  - $\log \left(\frac{\exp \left(z_u^T z_v\right)}{\sum_{n \in V} \exp \left(z_u^T z_n\right)}\right) \approx \log \left(\sigma\left(z_u^T z_v\right)\right)-\sum_{i=1}^K \log \left(\sigma\left(z_u^T z_{n_i}\right)\right)$,  
  - 其中$n_i$ ~ $P_v$（非均匀采样），K = 5 ~ 20

- 梯度下降

  - 随机梯度下降
  - 全局梯度下降
  - 小批量梯度下降

  

## Node2Vec

- 二阶的随机游走

- 通过两个超参数p和q控制随机游走的方向，

  - 其中概率1/p 表示退回上一个节点，概率q表示走向更远的节点，1表示走向上一个节点距离相等的节点
  - <img src="https://hc-images-1307048923.cos.ap-guangzhou.myqcloud.com/images/202302210016695.png" alt="image-20230221001615651" style="zoom:67%;" />

- 设置不同的超参数大小：

  - p大q小：DFS深度优先（探索远方），全局宏观，应用于同质社群（homophily community）
  - p小q大：BFS广度优先（探索近邻），局部微观，应用于节点功能角色（中枢、桥接、边缘）（structural equivalence）

- Node2Vec算法：（这三个步骤可以并行计算，可以大大加快计算速度）

  - 计算每个边的权重和概率，生成随机游走序列
  - 以u节点为起始节点，长度为l，生成r个随机游走序列
  - 用随机梯度下降优化目标函数

  

### 图机器学习 vs NLP


|  图机器  | NLP  |
|  ----  | ----  |
| 图 | 文章 |
| 随机游走序列 | 句子 |
| 节点 |单词
| DeepWalk|Skip-Gram|
|Node Embedding | Word Embedding|



## 矩阵分解角度图嵌入和随机游走

- 通过邻接矩阵分解$Z^TZ = A$，可得：
  - 两个节点之间相连：节点向量的数量积是1，两个节点是相似的
  - 两个节点之间不相连：节点向量的数量积是0，两个节点是不相似的
- Z 如果不是方阵，则用数值模拟
  - 优化函数：$min_{Z}||A - Z^{T}Z||_2$
- 基于随机游走的方法(DeepWark, Node2Vec等)都可以采用矩阵分解的方式表示，本质相同，是矩阵分解的某种特例

## 基于随机游走的图嵌入方法讨论  

- 基于随机游走的图嵌入的缺点：
  1. 随机游走的图嵌入方法都是对图中已有的节点计算特征，无法立刻泛化到新加入的节点，其实是某种程度的过拟合，当加入新节点时需要重新计算
  2. 只是探索相邻局部信息，只能采样出地理上相近的节点，无法采样地理远，但是结构相似的信息（可以采用匿名随机游走，图神经网络）
  3. 仅利用图本身的连接信息，并没有使用属性信息（图神经网络）



## 全图嵌入

- 直接对所有节点D维向量求和（或平均）  $Z_{G} = \sum_{v  \in G}{z_v}$

- 引入虚拟节点，与全图或子图相连，求出嵌入即全图的嵌入

- 匿名随机游走

  

### 匿名随机游走



- 每次见到不同的节点就发一个新编号，认号不认人
  - <img src="https://hc-images-1307048923.cos.ap-guangzhou.myqcloud.com/images/202302202324504.png" alt="image-20230220232422420" style="zoom:67%;" />

#### idea1

- Bag of Anoymous Walks
  - 采样出不同匿名随机游走序列的个数作为随机游走的向量
- 需要采样匿名游走序列的个数
  - <img src="https://hc-images-1307048923.cos.ap-guangzhou.myqcloud.com/images/202302202327246.png" alt="image-20230220232735200" style="zoom:67%;" />

#### idea2

- 构建自监督任务，构建全图嵌入编码和每种匿名随机游走序列编码
- 算法步骤：
  - 计算匿名随机游走嵌入编码$z_i$
  - 全图进行编码，并表示为D维向量 $z_G$
  - 对所有匿名随机游走序列编码表示的向量求平均，然后与全图编码的向量进行拼接，得到2D维向量 $cat(\frac{1}{Δ}∑_i^Δz_i,z_G)$
  - 进入线性分类层，预测出新的随机游走序列 $y(w_t) = b + U * (cat(\frac{1}{Δ}∑_i^Δz_i,z_G) )$
- 优化目标函数：
  - ![image-20230221003827353](https://hc-images-1307048923.cos.ap-guangzhou.myqcloud.com/images/202302210038402.png)



<img src="https://hc-images-1307048923.cos.ap-guangzhou.myqcloud.com/images/202302202332816.png" alt="image-20230220233202758" style="zoom: 67%;" />
